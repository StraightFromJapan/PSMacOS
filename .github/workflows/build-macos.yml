name: Build macOS DMG (Automated)

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: false
        default: 'release'

jobs:
  build-macos:
    runs-on: macos-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ðŸ“¦ Install dependencies
        run: npm install --legacy-peer-deps
      
      - name: Verify icon.png
        run: |
          if [ -f "icon.png" ]; then
            echo "âœ… icon.png found - electron-builder will convert it automatically"
            ls -lh icon.png
            file icon.png
          else
            echo "âš ï¸ No icon.png found - using default icon"
          fi
      
      - name: ðŸ—ï¸ Build macOS DMG
        run: npm run build-mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
      
      - name: ðŸ“Š Get build info
        id: build_info
        run: |
          DMG_FILE=$(find dist -name "*.dmg" | head -n 1)
          if [ -f "$DMG_FILE" ]; then
            DMG_SIZE=$(du -h "$DMG_FILE" | cut -f1)
            echo "dmg_path=$DMG_FILE" >> $GITHUB_OUTPUT
            echo "dmg_size=$DMG_SIZE" >> $GITHUB_OUTPUT
            echo "âœ… Build successful!"
            echo "ðŸ“¦ File: $DMG_FILE"
            echo "ðŸ“Š Size: $DMG_SIZE"
          else
            echo "âŒ No DMG file found"
            exit 1
          fi
      
      - name: ðŸ“¤ Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: Psychological-Studio-macOS-${{ github.run_number }}
          path: dist/*.dmg
          retention-days: 90
      
      - name: ðŸ“¤ Upload .app (for testing)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: Psychological-Studio-App-${{ github.run_number }}
          path: dist/mac-universal/*.app
          retention-days: 7
      
      - name: ðŸŽ‰ Build summary
        run: |
          echo "### âœ… macOS Build Successful! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**DMG File:** \`${{ steps.build_info.outputs.dmg_path }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Size:** ${{ steps.build_info.outputs.dmg_size }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ðŸ“¦ Features:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Universal Binary (Intel + Apple Silicon)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Complete file management" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Cross-platform projects" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Smooth performance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ðŸ“¥ Download:" >> $GITHUB_STEP_SUMMARY
          echo "Go to **Actions â†’ This workflow â†’ Artifacts** to download the DMG" >> $GITHUB_STEP_SUMMARY
